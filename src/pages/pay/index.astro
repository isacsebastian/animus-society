---
import Layout from "../../layouts/Layout.astro";
import CartIcon from "../../components/svg/CartIcon.astro";

const BACKEND = import.meta.env.PUBLIC_BACKEND_URL || "http://localhost:3000";
const OPPWA = import.meta.env.PUBLIC_OPPWA_URL || "https://eu-test.oppwa.com";

const genId = () => {
  const ts = Date.now().toString(36);
  const rnd = Math.random().toString(36).slice(2, 10);
  return `ORD_${ts}_${rnd}`.toUpperCase();
};
---

<Layout
  title="Pago - Animus Society"
  description="Completa tu compra en Animus Society de forma segura y rápida"
>
  <style>
    html,
    body {
      overflow: auto !important;
      height: auto !important;
    }

    .plan-option input:checked + div {
      border-color: #111827 !important;
      background-color: #f9fafb !important;
    }

    .plan-tab.active {
      background-color: white !important;
      color: #111827 !important;
      box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05) !important;
    }

    .plan-option {
      transition: all 0.2s ease-in-out;
    }

    .plan-option:hover div {
      border-color: #6b7280 !important;
    }
  </style>

  <div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto mb-4">
      <a
        href="/"
        class="inline-flex items-center justify-center w-10 h-10 text-gray-600 hover:text-gray-900 hover:bg-white rounded-full transition-all duration-200 shadow-sm border border-gray-200"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
      </a>
    </div>

    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div
          class="inline-flex items-center justify-center w-16 h-16 bg-gray-900 rounded-full mb-4"
        >
          <CartIcon className="w-8 h-8 text-white" />
        </div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Finalizar Compra</h1>
        <p class="text-gray-600">
          Completa tu información para procesar el pago
        </p>
      </div>

      <div class="grid lg:grid-cols-2 gap-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-6">
            Información de Pago
          </h2>

          <form id="pay-form" class="space-y-6" onsubmit="return false;">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label
                  for="givenName"
                  class="block text-sm font-medium text-gray-700 mb-2"
                >
                  Nombres
                </label>
                <input
                  type="text"
                  id="givenName"
                  name="givenName"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 transition-colors text-gray-900"
                  placeholder="Juan"
                />
              </div>
              <div>
                <label
                  for="middleName"
                  class="block text-sm font-medium text-gray-700 mb-2"
                >
                  Segundo nombre
                </label>
                <input
                  type="text"
                  id="middleName"
                  name="middleName"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 transition-colors text-gray-900"
                  placeholder="Pablo"
                />
              </div>
            </div>

            <div>
              <label
                for="surname"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                Apellidos
              </label>
              <input
                type="text"
                id="surname"
                name="surname"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 transition-colors text-gray-900"
                placeholder="Perez"
              />
            </div>

            <!-- ID Cliente -->
            <div>
              <label
                for="merchantCustomerId"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                ID Cliente (1-16 caracteres)
              </label>
              <input
                type="text"
                id="merchantCustomerId"
                name="merchantCustomerId"
                required
                maxlength="16"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 transition-colors text-gray-900"
                placeholder="USR123"
              />
            </div>

            <!-- Selección de Plan -->
            <div class="border-t border-gray-200 pt-6">
              <h3 class="text-lg font-medium text-gray-900 mb-4">
                Selecciona tu Plan
              </h3>

              <!-- Tabs para tipo de plan -->
              <div class="mb-6">
                <div class="flex bg-gray-100 rounded-lg p-1">
                  <button
                    id="tab-gym"
                    type="button"
                    class="plan-tab flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors bg-white text-gray-900 shadow-sm active"
                  >
                    Gimnasio
                  </button>
                  <button
                    id="tab-app"
                    type="button"
                    class="plan-tab flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-900"
                  >
                    App
                  </button>
                  <button
                    id="tab-test"
                    type="button"
                    class="plan-tab flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-900"
                  >
                    Pruebas
                  </button>
                </div>
              </div>

              <!-- Planes Gimnasio -->
              <div id="plans-gym" class="plan-section">
                <div class="grid gap-4">
                  <label class="plan-option cursor-pointer">
                    <input
                      type="radio"
                      name="selectedPlan"
                      value="gym-monthly"
                      data-price="77.00"
                      data-name="Animus Flow - Plan Mensual"
                      data-description="Plan mensual gimnasio"
                      class="sr-only"
                    />
                    <div
                      class="flex items-center justify-between p-4 border-2 border-gray-200 rounded-lg hover:border-gray-900 transition-colors"
                    >
                      <div class="flex-1">
                        <h4 class="font-medium text-gray-900">Animus Flow</h4>
                        <p class="text-sm text-gray-600">
                          Plan mensual recurrente
                        </p>
                      </div>
                      <div class="text-right">
                        <span class="text-2xl font-bold text-gray-900">$77</span
                        >
                        <p class="text-sm text-gray-600">/mes</p>
                      </div>
                    </div>
                  </label>

                  <label class="plan-option cursor-pointer">
                    <input
                      type="radio"
                      name="selectedPlan"
                      value="gym-yearly"
                      data-price="799.00"
                      data-name="Animus Legacy - Plan Anual"
                      data-description="Plan anual gimnasio"
                      class="sr-only"
                    />
                    <div
                      class="flex items-center justify-between p-4 border-2 border-gray-200 rounded-lg hover:border-gray-900 transition-colors relative"
                    >
                      <span
                        class="absolute -top-2 right-4 bg-yellow-500 text-gray-900 text-xs font-bold px-2 py-1 rounded-full"
                      >
                        Más popular
                      </span>
                      <div class="flex-1">
                        <h4 class="font-medium text-gray-900">Animus Legacy</h4>
                        <p class="text-sm text-gray-600">Plan anual completo</p>
                      </div>
                      <div class="text-right">
                        <span class="text-2xl font-bold text-gray-900"
                          >$799</span
                        >
                        <p class="text-sm text-gray-600">/año</p>
                      </div>
                    </div>
                  </label>
                </div>
              </div>

              <!-- Planes App -->
              <div id="plans-app" class="plan-section hidden">
                <div class="grid gap-4">
                  <label class="plan-option cursor-pointer">
                    <input
                      type="radio"
                      name="selectedPlan"
                      value="app-monthly"
                      data-price="19.99"
                      data-name="Animus Flow Online - Plan Mensual"
                      data-description="Plan mensual online"
                      class="sr-only"
                    />
                    <div
                      class="flex items-center justify-between p-4 border-2 border-gray-200 rounded-lg hover:border-gray-900 transition-colors"
                    >
                      <div class="flex-1">
                        <h4 class="font-medium text-gray-900">
                          Animus Flow Online
                        </h4>
                        <p class="text-sm text-gray-600">
                          Plan mensual sin compromiso
                        </p>
                      </div>
                      <div class="text-right">
                        <span class="text-2xl font-bold text-gray-900"
                          >$19<span class="text-lg">.99</span></span
                        >
                        <p class="text-sm text-gray-600">/mes</p>
                      </div>
                    </div>
                  </label>

                  <label class="plan-option cursor-pointer">
                    <input
                      type="radio"
                      name="selectedPlan"
                      value="app-yearly"
                      data-price="199.00"
                      data-name="Animus Legacy Online - Plan Anual"
                      data-description="Plan anual online"
                      class="sr-only"
                    />
                    <div
                      class="flex items-center justify-between p-4 border-2 border-gray-200 rounded-lg hover:border-gray-900 transition-colors relative"
                    >
                      <span
                        class="absolute -top-2 right-4 bg-yellow-500 text-gray-900 text-xs font-bold px-2 py-1 rounded-full"
                      >
                        Más popular
                      </span>
                      <div class="flex-1">
                        <h4 class="font-medium text-gray-900">
                          Animus Legacy Online
                        </h4>
                        <p class="text-sm text-gray-600">Plan anual completo</p>
                      </div>
                      <div class="text-right">
                        <span class="text-2xl font-bold text-gray-900"
                          >$199</span
                        >
                        <p class="text-sm text-gray-600">/año</p>
                      </div>
                    </div>
                  </label>
                </div>
              </div>

              <!-- Planes de Prueba -->
              <div id="plans-test" class="plan-section hidden">
                <div class="grid gap-4">
                  <label class="plan-option cursor-pointer">
                    <input
                      type="radio"
                      name="selectedPlan"
                      value="test-gym"
                      data-price="1.00"
                      data-name="Prueba Gimnasio - 1 Día"
                      data-description="Acceso de prueba gimnasio"
                      class="sr-only"
                    />
                    <div
                      class="flex items-center justify-between p-4 border-2 border-gray-200 rounded-lg hover:border-gray-900 transition-colors"
                    >
                      <div class="flex-1">
                        <h4 class="font-medium text-gray-900">
                          Prueba Gimnasio
                        </h4>
                        <p class="text-sm text-gray-600">
                          Acceso de 1 día al gimnasio
                        </p>
                      </div>
                      <div class="text-right">
                        <span class="text-2xl font-bold text-gray-900">$1</span>
                        <p class="text-sm text-gray-600">/día</p>
                      </div>
                    </div>
                  </label>

                  <label class="plan-option cursor-pointer">
                    <input
                      type="radio"
                      name="selectedPlan"
                      value="test-app"
                      data-price="1.00"
                      data-name="Prueba App - 1 Día"
                      data-description="Acceso de prueba app"
                      class="sr-only"
                    />
                    <div
                      class="flex items-center justify-between p-4 border-2 border-gray-200 rounded-lg hover:border-gray-900 transition-colors"
                    >
                      <div class="flex-1">
                        <h4 class="font-medium text-gray-900">Prueba App</h4>
                        <p class="text-sm text-gray-600">
                          Acceso de 1 día a la app
                        </p>
                      </div>
                      <div class="text-right">
                        <span class="text-2xl font-bold text-gray-900">$1</span>
                        <p class="text-sm text-gray-600">/día</p>
                      </div>
                    </div>
                  </label>
                </div>
              </div>

              <div class="space-y-4 mt-6">
                <!-- Monto (oculto, se actualiza automáticamente) -->
                <input type="hidden" id="amount" name="amount" value="77.00" />

                <!-- ID de Transacción -->
                <div>
                  <label
                    for="merchantTransactionId"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    ID de Transacción
                  </label>
                  <input
                    type="text"
                    id="merchantTransactionId"
                    name="merchantTransactionId"
                    required
                    readonly
                    value={genId()}
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 text-gray-600"
                  />
                </div>

                <!-- Desglose de Impuestos (calculados automáticamente) -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <div>
                    <label
                      for="base0"
                      class="block text-sm font-medium text-gray-700 mb-2"
                    >
                      Base 0%
                    </label>
                    <input
                      type="text"
                      id="base0"
                      name="base0"
                      required
                      readonly
                      value="0.00"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 text-gray-600"
                    />
                  </div>
                  <div>
                    <label
                      for="baseImp"
                      class="block text-sm font-medium text-gray-700 mb-2"
                    >
                      Base 12%
                    </label>
                    <input
                      type="text"
                      id="baseImp"
                      name="baseImp"
                      required
                      readonly
                      value="68.75"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 text-gray-600"
                    />
                  </div>
                  <div>
                    <label
                      for="iva"
                      class="block text-sm font-medium text-gray-700 mb-2"
                    >
                      IVA (12%)
                    </label>
                    <input
                      type="text"
                      id="iva"
                      name="iva"
                      required
                      readonly
                      value="8.25"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 text-gray-600"
                    />
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>

        <!-- Resumen del Pedido -->
        <div
          class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 h-fit"
        >
          <h2 class="text-xl font-semibold text-gray-900 mb-6">
            Estado de la Transacción
          </h2>

          <div class="space-y-4">
            <!-- Producto -->
            <div
              class="flex justify-between items-center py-3 border-b border-gray-200"
            >
              <div>
                <h3 id="summary-plan-name" class="font-medium text-gray-900">
                  Animus Flow - Plan Mensual
                </h3>
                <p id="summary-plan-description" class="text-sm text-gray-600">
                  Plan mensual gimnasio
                </p>
              </div>
              <span id="summary-plan-price" class="font-semibold text-gray-900"
                >$77.00</span
              >
            </div>

            <!-- Subtotal -->
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-600">Subtotal</span>
              <span id="summary-subtotal" class="text-gray-900">$77.00</span>
            </div>

            <!-- Impuestos -->
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-600">Impuestos (12%)</span>
              <span id="summary-tax" class="text-gray-900">$9.24</span>
            </div>

            <!-- Total -->
            <div class="border-t border-gray-200 pt-4">
              <div class="flex justify-between items-center">
                <span class="text-lg font-semibold text-gray-900">Total</span>
                <span
                  id="summary-total"
                  class="text-2xl font-bold text-gray-900">$86.24</span
                >
              </div>
            </div>

            <button
              id="btn-create"
              type="button"
              class="w-full bg-gray-900 text-white py-3 px-4 rounded-md font-medium hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900 transition-colors mt-6"
            >
              Crear checkout y pagar
            </button>

            <div class="text-center text-sm text-gray-500 mt-2">
              Se cargará el widget oficial del gateway
            </div>

            <div class="border-t border-gray-200 pt-6 mt-6">
              <div class="text-sm text-gray-600 mb-4">
                Marcas habilitadas:
                <span
                  class="inline-block bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs mx-1"
                  >VISA</span
                >
                <span
                  class="inline-block bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs mx-1"
                  >MASTER</span
                >
                <span
                  class="inline-block bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs mx-1"
                  >AMEX</span
                >
                <span
                  class="inline-block bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs mx-1"
                  >DINERS</span
                >
                <span
                  class="inline-block bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs mx-1"
                  >DISCOVER</span
                >
              </div>
              <div
                id="widget-mount"
                class="min-h-[200px] border border-gray-200 rounded-md p-4"
              >
              </div>
            </div>

            <div class="mt-4 p-3 bg-gray-50 rounded-md">
              <div class="flex items-center">
                <svg
                  class="w-5 h-5 text-green-500 mr-2"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                    clip-rule="evenodd"></path>
                </svg>
                <span class="text-sm text-gray-600"
                  >Pago 100% seguro y encriptado</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script define:vars={{ BACKEND, OPPWA }}>
  console.log("Configuración inicial:");
  console.log("BACKEND:", BACKEND);
  console.log("OPPWA:", OPPWA);

  const logEl = document.getElementById("log");
  const log = (m, cls = "") => {
    console.log("Log:", m);
    if (!logEl) return;
    const div = document.createElement("div");
    div.className = cls;
    div.textContent = typeof m === "string" ? m : JSON.stringify(m, null, 2);
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  };

  log("Página de pago iniciada");
  log(`Backend configurado: ${BACKEND}`);
  log(`OPPWA configurado: ${OPPWA}`);

  // Funciones para calcular impuestos
  function calculateTax(basePrice) {
    const base = parseFloat(basePrice);
    const taxRate = 0.12; // 12%
    const baseImp = base / (1 + taxRate);
    const tax = base - baseImp;

    return {
      baseImp: baseImp,
      tax: tax,
      total: base,
    };
  }

  function updatePricing(price, planName, planDescription) {
    const calculation = calculateTax(price);

    // Actualizar campos del formulario
    document.getElementById("amount").value = price.toFixed(2);
    document.getElementById("base0").value = "0.00";
    document.getElementById("baseImp").value = calculation.baseImp.toFixed(2);
    document.getElementById("iva").value = calculation.tax.toFixed(2);

    // Actualizar resumen
    document.getElementById("summary-plan-name").textContent = planName;
    document.getElementById("summary-plan-description").textContent =
      planDescription;
    document.getElementById("summary-plan-price").textContent =
      `$${price.toFixed(2)}`;
    // Subtotal sin IVA (base imponible)
    document.getElementById("summary-subtotal").textContent =
      `$${calculation.baseImp.toFixed(2)}`;
    document.getElementById("summary-tax").textContent =
      `$${calculation.tax.toFixed(2)}`;
    document.getElementById("summary-total").textContent =
      `$${calculation.total.toFixed(2)}`;
  }

  // Inicialización del DOM
  document.addEventListener("DOMContentLoaded", function () {
    // Tabs de categorías
    const planTabs = document.querySelectorAll(".plan-tab");
    const planSections = document.querySelectorAll(".plan-section");

    planTabs.forEach((tab) => {
      tab.addEventListener("click", function () {
        const targetSection = this.id.replace("tab-", "plans-");

        // Actualizar tabs activos
        planTabs.forEach((t) => {
          t.classList.remove(
            "active",
            "bg-white",
            "text-gray-900",
            "shadow-sm"
          );
          t.classList.add("text-gray-600", "hover:text-gray-900");
        });

        this.classList.add("active", "bg-white", "text-gray-900", "shadow-sm");
        this.classList.remove("text-gray-600", "hover:text-gray-900");

        // Mostrar sección correspondiente
        planSections.forEach((section) => {
          section.classList.add("hidden");
        });

        document.getElementById(targetSection).classList.remove("hidden");

        // Seleccionar el primer plan de la nueva sección
        const firstPlan = document.querySelector(
          `#${targetSection} input[name="selectedPlan"]`
        );
        if (firstPlan) {
          firstPlan.checked = true;
          selectPlan(firstPlan);
        }
      });
    });

    // Selección de planes
    const planOptions = document.querySelectorAll('input[name="selectedPlan"]');

    function selectPlan(planInput) {
      const price = parseFloat(planInput.getAttribute("data-price"));
      const planName = planInput.getAttribute("data-name");
      const planDescription = planInput.getAttribute("data-description");

      // Actualizar estilos visuales
      document.querySelectorAll(".plan-option > div").forEach((div) => {
        div.classList.remove("border-gray-900", "bg-gray-50");
        div.classList.add("border-gray-200");
      });

      const selectedDiv = planInput.parentElement.querySelector("div");
      selectedDiv.classList.add("border-gray-900", "bg-gray-50");
      selectedDiv.classList.remove("border-gray-200");

      // Actualizar precios
      updatePricing(price, planName, planDescription);
    }

    planOptions.forEach((option) => {
      option.addEventListener("change", function () {
        if (this.checked) {
          selectPlan(this);
        }
      });
    });

    // Seleccionar el primer plan por defecto
    const defaultPlan = document.querySelector('input[name="selectedPlan"]');
    if (defaultPlan) {
      defaultPlan.checked = true;
      selectPlan(defaultPlan);
    }
  });

  async function createCheckout(payload) {
    const res = await fetch("/api/payments/checkouts", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  function loadWidget(checkoutId) {
    const mount = document.getElementById("widget-mount");
    if (!mount) return;
    mount.innerHTML = `
      <form action="${BACKEND}/api/payments/status" class="paymentWidgets"
            data-brands="VISA"
            data-shopper-result-url="${BACKEND}/api/payments/status">
      </form>`;

    const s = document.createElement("script");
    s.src = `${OPPWA}/v1/paymentWidgets.js?checkoutId=${checkoutId}`;
    s.async = true;
    s.onload = () => log("Widget cargado ✓", "ok");
    s.onerror = () => log("Error cargando widget", "err");
    document.body.appendChild(s);
  }

  const btnCreate = document.getElementById("btn-create");
  if (btnCreate) {
    btnCreate.addEventListener("click", async () => {
      log(`BACKEND URL: ${BACKEND}`);
      log(`OPPWA URL: ${OPPWA}`);

      const payForm = document.getElementById("pay-form");
      if (!payForm) {
        log("No se encontró el formulario", "err");
        return;
      }

      const fd = new FormData(payForm);
      const amount = String(fd.get("amount") || "1.00").trim();

      // Verificar que se haya seleccionado un plan
      const selectedPlan = document.querySelector(
        'input[name="selectedPlan"]:checked'
      );
      if (!selectedPlan) {
        alert("Por favor selecciona un plan");
        return;
      }

      // Solo validar límite para planes que no sean de prueba (test)
      if (!selectedPlan.value.includes("test") && parseFloat(amount) > 50) {
        log("En sandbox, amount ≤ 50.00", "err");
        alert("En el ambiente de pruebas, el monto debe ser ≤ $50.00");
        return;
      }

      const payload = {
        amount,
        currency: "USD",
        paymentType: "DB",
        merchantTransactionId: String(fd.get("merchantTransactionId")),
        givenName: String(fd.get("givenName")),
        middleName: String(fd.get("middleName")),
        surname: String(fd.get("surname")),
        customerIp: "",
        merchantCustomerId: String(fd.get("merchantCustomerId")),
        base0: String(fd.get("base0")),
        baseImp: String(fd.get("baseImp")),
        iva: String(fd.get("iva")),
      };

      log("Payload a enviar:");
      log(payload);

      try {
        log("Creando checkout...");
        log(`URL destino: /api/payments/checkouts`);

        const data = await createCheckout(payload);
        log("Respuesta del servidor:");
        log(data);

        if (!data?.id) {
          throw new Error("No se recibió checkoutId en la respuesta");
        }

        log(`CheckoutId recibido: ${data.id}`);
        loadWidget(data.id);
      } catch (e) {
        const errorMessage = e instanceof Error ? e.message : String(e);
        log(`Error completo: ${errorMessage}`, "err");
        console.error("Error detallado:", e);
        alert(`Error al procesar el pago: ${errorMessage}`);
      }
    });
  }
</script>
